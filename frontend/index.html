<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="favicon.ico" />
<title>Poster</title>
<style>
  :root {
    --bg: #0f1115;
    --card: #1a1d23;
    --accent: #4caf50;
    --text: #f0f0f0;
    --muted: #999;
    --danger: #e74c3c;
  }
  body {
    margin:0; padding:0;
    font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    background: var(--bg);
    color: var(--text);
    display:flex; flex-direction:column; align-items:center;
    min-height:100vh;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  header {
    width:100%; padding:1rem 2rem;
    display:flex; justify-content:center; align-items:center;
    background:#15171c; position:sticky; top:0; z-index:100;
    box-shadow:0 2px 5px rgba(0,0,0,0.4);
  }
  header .container { width:90%; max-width:1100px; display:flex; justify-content:space-between; align-items:center; }
  header h1 { margin:0; font-size:1.5rem;}
  #new-post-btn { background: var(--accent); color:#fff; border:none;
    padding:0.6rem 1.2rem; border-radius:10px; cursor:pointer; font-weight:600;}
  #new-post-btn:hover{background:#5ed162;}

  #post-form { display:none; flex-direction:column; background:var(--card);
    padding:1rem 1.5rem; border-radius:12px; width:92%; max-width:820px;
    margin:1.5rem auto; box-shadow:0 0 18px rgba(0,0,0,0.5);}
  #post-form input, #post-form textarea {
    background:#23262d; color: var(--text); border:1px solid #333;
    border-radius:8px; padding:0.7rem; margin:0.4rem 0; font-size:1rem; width:100%;
  }
  #form-buttons { display:flex; justify-content:flex-end; gap:0.8rem; margin-top:0.5rem; }
  #submit-post { background: var(--accent); color:#fff; border:none; border-radius:6px; padding:0.6rem 1.2rem; cursor:pointer;}
  #submit-post:hover { background:#5ed162; }
  #cancel-post { background:#444; color:#ccc; border:none; border-radius:6px; padding:0.6rem 1.2rem; cursor:pointer;}
  #cancel-post:hover { background:#555; }

  main.container { width:90%; max-width:1100px; margin-top:1.25rem; }
  #posts { width:100%; display:grid; grid-template-columns:repeat(auto-fill,minmax(360px,1fr)); gap:1.4rem; margin-bottom:3rem; align-items:start; }
  .post-card { background:var(--card); border-radius:14px; padding:1.4rem 1.6rem;
    box-shadow:0 6px 18px rgba(0,0,0,0.45); display:flex; flex-direction:column;
    justify-content:space-between; transition: transform 0.18s, box-shadow 0.18s; min-height:160px; }
  .post-card:hover { transform:translateY(-4px); box-shadow:0 4px 12px rgba(0,0,0,0.6);}
  .post-header { display:flex; justify-content:space-between; align-items:start;}
  .post-header h3 { margin:0; font-size:1.2rem; line-height:1.25;}
  .post-date { font-size:0.82rem; color: var(--muted); margin-top:0.28rem;}
  .post-content { margin-top:0.9rem; color:#ddd; line-height:1.6; word-break:break-word; font-size:0.98rem;}
  .post-content { transition: max-height 0.22s ease; }
  .post-content.collapsed { max-height:120px; overflow:hidden; position:relative; }
  .post-content.collapsed::after { content:''; position:absolute; left:0; right:0; bottom:0; height:40px; background:linear-gradient(180deg, rgba(26,29,35,0) 0%, rgba(26,29,35,0.95) 85%); pointer-events:none; border-bottom-left-radius:12px; border-bottom-right-radius:12px; }
  .expand-btn { background:none; border:none; color:var(--accent); cursor:pointer; padding:0.25rem 0; font-weight:600; align-self:flex-start; margin-top:0.5rem; }
  .expand-btn:hover{ text-decoration:underline; }
  .delete-btn { background:none; border:none; color: var(--danger); font-size:1.2rem; cursor:pointer; padding:0; transition: opacity 0.2s;}
  .delete-btn:hover { opacity:0.8;}
  /* Modal / exploded card styles */
  #post-modal { display:none; }
  #post-modal .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999;padding:1rem}
  #post-modal .modal-card{background:var(--card);color:var(--text);max-width:900px;width:100%;border-radius:12px;padding:1.25rem;box-shadow:0 12px 40px rgba(0,0,0,0.6);max-height:90vh;overflow:auto;position:relative}
  #post-modal .modal-close{position:absolute;right:0.75rem;top:0.5rem;background:none;border:none;color:var(--text);cursor:pointer;font-size:1.1rem}
  #post-modal .modal-title{font-size:1.35rem;margin:0}
  #post-modal .modal-date{font-size:0.85rem;color:var(--muted);margin-top:0.35rem}
  #post-modal .modal-body{margin-top:0.9rem;color:#ddd;line-height:1.6;white-space:pre-wrap}
</style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
</head>
<body>
<header>
  <div class="container">
    <h1 style="display:flex;align-items:center;gap:0.6rem;font-size:1.25rem;">
      <img src="logo.svg" alt="Logo" width="36" height="36"/>
      Poster
    </h1>
    <button id="new-post-btn">Ôºã New</button>
  </div>
</header>

<form id="post-form">
  <input type="text" id="title" placeholder="Post title" required>
  <textarea id="content" rows="5" placeholder="Write your post..." required></textarea>
  <div id="form-buttons">
    <button type="button" id="cancel-post">Cancel</button>
    <button type="submit" id="submit-post">Publish</button>
  </div>
</form>

<main class="container">
  <div id="posts"></div>
</main>

<script>
// Determine API base so app works on poster.local (prod) and localhost (dev)
const backendDefaultPort = 3001; // matches backend default PORT
const devHosts = ['localhost', '127.0.0.1', '::1'];
const API_PREFIX = devHosts.includes(window.location.hostname)
  ? `http://localhost:${backendDefaultPort}/api`
  : `${window.location.origin}/api`; // in prod (poster.local) API lives under /api
const apiUrl = `${API_PREFIX}/posts`;
const postContainer = document.getElementById("posts");
const postForm = document.getElementById("post-form");
const newPostBtn = document.getElementById("new-post-btn");
const cancelPostBtn = document.getElementById("cancel-post");

newPostBtn.addEventListener("click", ()=>{
  postForm.style.display="flex";
  newPostBtn.style.display="none";
});
cancelPostBtn.addEventListener("click", ()=>{
  postForm.reset();
  postForm.style.display="none";
  newPostBtn.style.display="inline-block";
});

postForm.addEventListener("submit", async(e)=>{
  e.preventDefault();
  const title = document.getElementById("title").value.trim();
  const content = document.getElementById("content").value.trim();
  if(!title||!content) return;
  try{
    const res = await fetch(apiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title,content,date:new Date().toISOString()})});
    if(!res.ok) throw new Error("Failed to post");
    postForm.reset();
    postForm.style.display="none";
    newPostBtn.style.display="inline-block";
    loadPosts();
  }catch(err){console.error(err); alert("Failed to create post.");}
});

async function loadPosts(){
  try{
    const res = await fetch(apiUrl);
    if(!res.ok) throw new Error("Failed to load posts");
    const posts = await res.json();
    postContainer.innerHTML="";
    posts.forEach(post=>{
      const card=document.createElement("div");
      card.className="post-card";
        card.innerHTML=`<div class="post-header">
          <div><h3>${escapeHtml(post.title)}</h3><div class="post-date">${new Date(post.date).toLocaleString()}</div></div>
          <button class="delete-btn" data-id="${post.id}">üóëÔ∏è</button>
        </div>
        <div class="post-content">${DOMPurify.sanitize(marked.parse(post.content))}</div>`;
        const deleteBtnHandler = async()=>{
        try{
          const res=await fetch(`${apiUrl}/${post.id}`,{method:"DELETE"});
          if(!res.ok) throw new Error("Delete failed");
          loadPosts();
        }catch(err){console.error(err); alert("Failed to delete post");}
        };
        card.querySelector(".delete-btn").addEventListener("click", deleteBtnHandler);

        // Open exploded modal when clicking the card (but ignore clicks on buttons inside card)
        card.addEventListener('click', (e)=>{
          const btn = e.target.closest('button');
          if(btn) return; // clicked a button (delete/expand) so ignore
          openModal(post);
        });

        // Make content collapsible if too long
        const contentEl = card.querySelector('.post-content');
        // Use a timeout to ensure styles/layout applied
        setTimeout(()=>{
          const fullHeight = contentEl.scrollHeight;
          const collapsedHeight = 120; // px
          if(fullHeight > collapsedHeight + 20){
            contentEl.classList.add('collapsed');
            const btn = document.createElement('button');
            btn.className = 'expand-btn';
            btn.textContent = 'Read more';
            let expanded = false;
            btn.addEventListener('click', ()=>{
              expanded = !expanded;
              if(expanded){
                contentEl.classList.remove('collapsed');
                btn.textContent = 'Show less';
              }else{
                contentEl.classList.add('collapsed');
                btn.textContent = 'Read more';
              }
            });
            contentEl.insertAdjacentElement('afterend', btn);
          }
        }, 50);
      postContainer.appendChild(card);
    });
  }catch(err){console.error(err); postContainer.innerHTML="<div style='color:red'>Failed to load posts</div>";}
}

loadPosts();

    // --- Modal DOM + handlers (exploded card) ---
    const modalWrapper = document.createElement('div');
    modalWrapper.id = 'post-modal';
    modalWrapper.innerHTML = `
      <div class="modal-backdrop" role="dialog" aria-modal="true">
        <div class="modal-card">
          <button class="modal-close" aria-label="Close">‚úï</button>
          <h2 class="modal-title"></h2>
          <div class="modal-date"></div>
          <div class="modal-body"></div>
        </div>
      </div>
    `;
    document.body.appendChild(modalWrapper);

    function openModal(post){
      modalWrapper.style.display = 'block';
      const titleEl = modalWrapper.querySelector('.modal-title');
      const dateEl = modalWrapper.querySelector('.modal-date');
      const bodyEl = modalWrapper.querySelector('.modal-body');
      titleEl.textContent = post.title;
      dateEl.textContent = new Date(post.date).toLocaleString();
      bodyEl.innerHTML = DOMPurify.sanitize(marked.parse(post.content));
      // focus close button for accessibility
      modalWrapper.querySelector('.modal-close').focus();
      // add escape key listener
      document.addEventListener('keydown', modalEscapeHandler);
    }

    function closeModal(){
      modalWrapper.style.display = 'none';
      document.removeEventListener('keydown', modalEscapeHandler);
    }

    function modalEscapeHandler(e){ if(e.key === 'Escape') closeModal(); }

    modalWrapper.addEventListener('click', (e)=>{
      if(e.target.classList.contains('modal-backdrop')) closeModal();
    });
    modalWrapper.querySelector('.modal-close').addEventListener('click', closeModal);
</script>
</body>
</html>
